# Generated by sonnet CLI - {{ project_name }}
# Do not edit manually unless you know what you're doing

services:
{% for service_name in services %}
{% set svc = service_registry[service_name] %}
  {{ service_name }}:
    image: {{ svc.image }}
    container_name: {{ project_name }}_{{ service_name }}
{% if svc.ports %}
    ports:
{% for host_port, container_port in svc.ports.items() %}
      - "{{ host_port }}:{{ container_port }}"
{% endfor %}
{% endif %}
{% if svc.environment %}
    environment:
{% for key, value in svc.environment.items() %}
      {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}
{% if service_name == 'pgadmin' %}
    volumes:
      - ./config/pgadmin/servers.json:/pgadmin4/servers.json
      - ./config/pgadmin/preferences.json:/pgadmin4/preferences.json
      - ./config/pgadmin/pgpass:/pgadmin4/pgpass
    entrypoint: >
      sh -c "
        chmod 600 /pgadmin4/pgpass &&
        chmod 600 /pgadmin4/servers.json &&
        chmod 644 /pgadmin4/preferences.json &&
        /venv/bin/python3 /pgadmin4/setup.py load-servers /pgadmin4/servers.json &&
        /entrypoint.sh
      "
{% elif svc.volumes %}
    volumes:
{% for vol in svc.volumes %}
      - {{ vol }}
{% endfor %}
{% endif %}
{% if svc.command %}
    command: {{ svc.command | tojson }}
{% endif %}
{% if service_name in dependencies and dependencies[service_name] %}
    depends_on:
{% for dep in dependencies[service_name] %}
      {{ dep }}:
        condition: service_{% if dep == 'pgduckdb' %}healthy{% else %}started{% endif %}

{% endfor %}
{% endif %}
{% if svc.healthcheck %}
    healthcheck:
      test: {{ svc.healthcheck.test | tojson }}
      retries: {{ svc.healthcheck.retries }}
{% endif %}

{% endfor %}
volumes:
{% if 'pgduckdb' in services %}
  pgduckdb_data:
    driver: local
{% endif %}
{% if 'cloudbeaver' in services %}
  cloudbeaver-data:
    driver: local
{% endif %}
{% if 'dbtbase' in services %}
  dbt_data:
    driver: local
{% endif %}
